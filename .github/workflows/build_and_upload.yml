name: Build and Upload

on:
  workflow_call:
    inputs:
      isRelease:
        required: true
        type: boolean
      shouldUpload:
        required: true
        type: boolean

env:
  RELEASE: ${{ inputs.isRelease }}

jobs:
  build_mac:
    name: Build Mac64
    runs-on: macos-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Build project
        run: |
          ./gradlew build_project_mac64 build_project_macArm

      - name: Upload natives
        uses: actions/upload-artifact@v4
        with:
          name: mac-natives
          path: ./example/lib/lib-build/build/c++/libs/

  build_linux:
    name: Build Linux64
    runs-on: ubuntu-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Set up MinGW
        run: |
          sudo apt install -y --force-yes mingw-w64 lib32z1

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew build_project_linux64

      - name: Upload natives
        uses: actions/upload-artifact@v4
        with:
          name: linux-natives
          path: ./example/lib/lib-build/build/c++/libs/

  build_windows:
    name: Build Windows64
    runs-on: ubuntu-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Set up MinGW
        run: |
          sudo apt install -y --force-yes mingw-w64 lib32z1

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew build_project_windows64

      - name: Upload natives
        uses: actions/upload-artifact@v4
        with:
          name: windows-natives
          path: ./example/lib/lib-build/build/c++/libs/

  build_teavm:
    name: Build TeaVM
    runs-on: ubuntu-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Set up MinGW
        run: |
          sudo apt install -y --force-yes mingw-w64 lib32z1

      - name: Install emscripten
        uses: mymindstorm/setup-emsdk@v14

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew build_project_teavm

      - name: Upload natives
        uses: actions/upload-artifact@v4
        with:
          name: teavm-natives
          path: ./example/lib/lib-build/build/c++/libs/

  build_android:
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Set up MinGW
        run: |
          sudo apt install -y --force-yes mingw-w64 lib32z1

      - name: Install NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: false

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew build_project_android
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
      - name: Upload natives
        uses: actions/upload-artifact@v4
        with:
          name: android-natives
          path: ./example/lib/lib-build/build/c++/libs/
  
  upload_natives:
    name: Upload Natives
    needs: [build_windows, build_linux, build_mac, build_android, build_teavm]
    runs-on: ubuntu-latest

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 11

      - name: Set up MinGW
        run: |
          sudo apt install -y --force-yes mingw-w64 lib32z1

      - name: Change wrapper permissions
        run: chmod +x ./gradlew

      - name: Download windows natives
        uses: actions/download-artifact@v4
        with:
          name: windows-natives
          path: ./example/lib/lib-build/build/c++/libs/

      - name: Download linux natives
        uses: actions/download-artifact@v4
        with:
          name: linux-natives
          path: ./example/lib/lib-build/build/c++/libs/

      - name: Download mac natives
        uses: actions/download-artifact@v4
        with:
          name: mac-natives
          path: ./example/lib/lib-build/build/c++/libs/

      - name: Download android natives
        uses: actions/download-artifact@v4
        with:
          name: android-natives
          path: ./example/lib/lib-build/build/c++/libs/

      - name: Download teavm natives
        uses: actions/download-artifact@v4
        with:
          name: teavm-natives
          path: ./example/lib/lib-build/build/c++/libs/

      - name: Upload to repository
        if: ${{ inputs.shouldUpload }}
        run: ./gradlew publish
        env:
          USER: ${{ secrets.USER }}
          PASSWORD: ${{ secrets.PASSWORD }}
          SIGNING_KEY: ${{ secrets.PGP_SECRET }}
          SIGNING_PASSWORD: ${{ secrets.PGP_PASSPHRASE }}


  
  
  
  
  
  
  

#  build_mac64:
#    name: Build mac
#    runs-on: macos-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up JDK 11
#        uses: actions/setup-java@v4
#        with:
#          distribution: "zulu"
#          java-version: 11
#
#      - name: Change wrapper permissions
#        run: chmod +x ./gradlew
#
#      - name: clang targets
#        shell: bash
#        run: clang++ --print-targets
#
#      - name: clang supported-cpus
#        shell: bash
#        run: clang++ --print-supported-cpus
#
#      - name: Build project
#        run: |
#          # See https://github.com/actions/virtual-environments/issues/2557
#          sudo mv /Library/Developer/CommandLineTools/SDKs/* /tmp
#          sudo mv /Applications/Xcode.app /Applications/Xcode.app.bak
#          sudo mv /Applications/Xcode_14.3.1.app /Applications/Xcode.app
#          sudo xcode-select -switch /Applications/Xcode.app
#          /usr/bin/xcodebuild -version
#          ./gradlew build_project_mac64

#  build_Linux:
#    name: Build Linux
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v3
#
#      - name: Set up JDK 11
#        uses: actions/setup-java@v3
#        with:
#          distribution: "zulu"
#          java-version: 11
#
#      - name: Check Ant
#        run: ant -version
#
#      - name: Set up MinGW
#        run: |
#          sudo apt install -y --force-yes mingw-w64 lib32z1
#
#      - name: Install emscripten
#        uses: mymindstorm/setup-emsdk@v14
#
#      - name: Install NDK
#        id: setup-ndk
#        uses: nttld/setup-ndk@v1
#        with:
#          ndk-version: r25c
#          add-to-path: false
#
#      - name: Change wrapper permissions
#        run: chmod +x ./gradlew
#
#      - name: Build project
#        run: ./gradlew build_project
#        env:
#          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
#
#      - name: Build classes
#        run: ./gradlew build
#
#      - name: Upload to repository
#        if: ${{ inputs.shouldUpload }}
#        run: ./gradlew publish
#        env:
#          USER: ${{ secrets.USER }}
#          PASSWORD: ${{ secrets.PASSWORD }}
#          SIGNING_KEY: ${{ secrets.PGP_SECRET }}
#          SIGNING_PASSWORD: ${{ secrets.PGP_PASSPHRASE }}
